<app-sidebar></app-sidebar>

<div class="user-control">
  <!-- Page Header -->
  <header class="user-control__header">
    <div class="user-control__header-left">
      <h1 class="user-control__title">المستخدمون</h1>
      <p class="user-control__subtitle">إدارة حسابات المستخدمين والصلاحيات</p>
    </div>
    <div class="user-control__header-right">
      <button class="btn btn--primary" (click)="openAddUserModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        <span>إضافة مستخدم</span>
      </button>
    </div>
  </header>

  <!-- Search and Filter Section -->
  <section class="user-control__filters">
    <div class="search-box">
      <input
        type="text"
        class="search-box__input"
        placeholder="بحث بالاسم أو البريد الالكتروني..."
        [(ngModel)]="searchTerm"
        (input)="filterUsers()"
      >
      <svg class="search-box__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <path d="m21 21-4.35-4.35"/>
      </svg>
    </div>

    <div class="filter-group">
      <select class="filter-select" [(ngModel)]="selectedRole" (change)="filterUsers()">
        <option value="">جميع الأدوار</option>
        <option value="admin">مدير</option>
        <option value="employee">محرر</option>
      </select>

      <select class="filter-select" [(ngModel)]="selectedStatus" (change)="filterUsers()">
        <option value="">جميع الحالات</option>
        <option value="active">نشط</option>
        <option value="inactive">معطل</option>
      </select>
    </div>
  </section>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>جاري التحميل...</p>
  </div>

  <!-- Error State -->
  <div class="error-container" *ngIf="error && !isLoading">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"/>
      <line x1="12" y1="8" x2="12" y2="12"/>
      <line x1="12" y1="16" x2="12.01" y2="16"/>
    </svg>
    <p>{{ error }}</p>
    <button class="btn btn--secondary" (click)="loadUsers()">إعادة المحاولة</button>
  </div>

  <!-- Users Table -->
  <section class="users-table-section" *ngIf="!isLoading && !error">
    <div class="users-table">
      <!-- Table Header -->
      <div class="users-table__header">
        <div class="users-table__cell users-table__cell--checkbox">
          <input
            type="checkbox"
            class="checkbox"
            [checked]="allSelected"
            (change)="toggleSelectAll()"
          >
        </div>
        <div class="users-table__cell">الاسم</div>
        <div class="users-table__cell">البريد الالكتروني</div>
        <div class="users-table__cell">الدور</div>
        <div class="users-table__cell">الحالة</div>
        <div class="users-table__cell">تاريخ التسجيل</div>
        <div class="users-table__cell users-table__cell--actions">إجراءات</div>
      </div>

      <!-- Table Body -->
      <div class="users-table__body" *ngIf="filteredUsers.length > 0">
        <div class="users-table__row" *ngFor="let user of filteredUsers">
          <div class="users-table__cell users-table__cell--checkbox">
            <input
              type="checkbox"
              class="checkbox"
              [(ngModel)]="user.selected"
              (change)="updateSelectAll()"
            >
          </div>

          <div class="users-table__cell">
            <div class="user-info">
              <div class="user-info__avatar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                  <circle cx="12" cy="7" r="4"/>
                </svg>
              </div>
              <span class="user-info__name">{{ user.name || user.username || 'مستخدم' }}</span>
            </div>
          </div>

          <div class="users-table__cell">
            <div class="email-cell">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="4" width="20" height="16" rx="2"/>
                <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
              </svg>
              <span>{{ user.email }}</span>
            </div>
          </div>

          <div class="users-table__cell">
            <span class="role-badge" [class]="'role-badge--' + user.role">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle *ngIf="user.role === 'admin'" cx="12" cy="12" r="3"/>
                <path *ngIf="user.role === 'admin'" d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"/>
                <circle *ngIf="user.role === 'employee'" cx="12" cy="8" r="4"/>
                <path *ngIf="user.role === 'employee'" d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              </svg>
              {{ user.role === 'admin' ? 'مدير' : 'محرر' }}
            </span>
          </div>

          <div class="users-table__cell">
            <span class="status-badge" [class]="'status-badge--' + ((user.isActive !== false) ? 'success' : 'danger')">
              {{ (user.isActive !== false) ? 'نشط' : 'معطل' }}
            </span>
          </div>

          <div class="users-table__cell">
            <span class="date-text">{{ user.createdAt | date: 'yyyy-MM-dd' }}</span>
          </div>

          <div class="users-table__cell users-table__cell--actions">
            <div class="action-buttons">
              <button
                class="action-btn action-btn--edit"
                (click)="openEditUserModal(user)"
                [title]="'تعديل'"
              >
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
              </button>

              <button
                class="action-btn action-btn--password"
                (click)="openPasswordModal(user)"
                [title]="'تغيير كلمة المرور'"
              >
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                  <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
              </button>

              <button
                class="action-btn action-btn--delete"
                (click)="confirmDeleteUser(user)"
                [title]="'حذف'"
                [disabled]="user._id === currentUserId"
              >
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  <line x1="10" y1="11" x2="10" y2="17"/>
                  <line x1="14" y1="11" x2="14" y2="17"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="filteredUsers.length === 0">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
          <circle cx="9" cy="7" r="4"/>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
        <h3>لا يوجد مستخدمون</h3>
        <p>{{ searchTerm ? 'لم يتم العثور على نتائج' : 'ابدأ بإضافة مستخدمين جدد' }}</p>
      </div>
    </div>

    <!-- Bulk Actions -->
    <div class="bulk-actions" *ngIf="selectedCount > 0">
      <span class="bulk-actions__count">تم تحديد {{ selectedCount }} مستخدم</span>
      <button class="btn btn--danger-outline" (click)="confirmBulkDelete()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="3 6 5 6 21 6"/>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
        </svg>
        حذف المحددين
      </button>
    </div>
  </section>

  <!-- Add/Edit User Modal -->
  <div class="modal-overlay" *ngIf="showUserModal" (click)="closeUserModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal__header">
        <h2>{{ isEditMode ? 'تعديل المستخدم' : 'إضافة مستخدم جديد' }}</h2>
        <button class="modal__close" (click)="closeUserModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <form class="modal__body" (ngSubmit)="saveUser()">
        <div class="form-group">
          <label class="form-label">الاسم *</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="userForm.name"
            name="name"
            placeholder="أدخل اسم المستخدم"
            required
          >
        </div>

        <div class="form-group">
          <label class="form-label">البريد الإلكتروني *</label>
          <input
            type="email"
            class="form-input"
            [(ngModel)]="userForm.email"
            name="email"
            placeholder="example@domain.com"
            required
          >
        </div>

        <div class="form-group" *ngIf="!isEditMode">
          <label class="form-label">كلمة المرور *</label>
          <div class="password-input">
            <input
              [type]="showPassword ? 'text' : 'password'"
              class="form-input"
              [(ngModel)]="userForm.password"
              name="password"
              placeholder="أدخل كلمة المرور (6 أحرف على الأقل)"
              [required]="!isEditMode"
            >
            <button
              type="button"
              class="password-toggle"
              (click)="showPassword = !showPassword"
            >
              <svg *ngIf="!showPassword" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
              <svg *ngIf="showPassword" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                <line x1="1" y1="1" x2="23" y2="23"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">الدور *</label>
          <select class="form-select" [(ngModel)]="userForm.role" name="role" required>
            <option value="employee">محرر</option>
            <option value="admin">مدير</option>
          </select>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn--secondary" (click)="closeUserModal()">
            إلغاء
          </button>
          <button type="submit" class="btn btn--primary" [disabled]="isSaving">
            <span *ngIf="!isSaving">{{ isEditMode ? 'حفظ التغييرات' : 'إضافة المستخدم' }}</span>
            <span *ngIf="isSaving">جاري الحفظ...</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div class="modal-overlay" *ngIf="showPasswordModal" (click)="closePasswordModal()">
    <div class="modal modal--small" (click)="$event.stopPropagation()">
      <div class="modal__header">
        <h2>تغيير كلمة المرور</h2>
        <button class="modal__close" (click)="closePasswordModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <form class="modal__body" (ngSubmit)="updatePassword()">
        <p class="modal__description">
          تغيير كلمة المرور لـ: <strong>{{ selectedUser?.name || selectedUser?.username || 'المستخدم' }}</strong>
        </p>

        <div class="form-group">
          <label class="form-label">كلمة المرور الجديدة *</label>
          <div class="password-input">
            <input
              [type]="showNewPassword ? 'text' : 'password'"
              class="form-input"
              [(ngModel)]="newPassword"
              name="newPassword"
              placeholder="أدخل كلمة المرور الجديدة (6 أحرف على الأقل)"
              required
            >
            <button
              type="button"
              class="password-toggle"
              (click)="showNewPassword = !showNewPassword"
            >
              <svg *ngIf="!showNewPassword" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
              <svg *ngIf="showNewPassword" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                <line x1="1" y1="1" x2="23" y2="23"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn--secondary" (click)="closePasswordModal()">
            إلغاء
          </button>
          <button type="submit" class="btn btn--primary" [disabled]="isSaving">
            <span *ngIf="!isSaving">تحديث كلمة المرور</span>
            <span *ngIf="isSaving">جاري التحديث...</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" *ngIf="showDeleteModal" (click)="closeDeleteModal()">
    <div class="modal modal--small" (click)="$event.stopPropagation()">
      <div class="modal__header modal__header--danger">
        <h2>تأكيد الحذف</h2>
        <button class="modal__close" (click)="closeDeleteModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <div class="modal__body">
        <div class="delete-warning">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/>
          </svg>
          <p>
            هل أنت متأكد من حذف
            <strong>{{ usersToDelete.length === 1 ? (selectedUser?.name || selectedUser?.username || 'المستخدم') : usersToDelete.length + ' مستخدمين' }}</strong>؟
          </p>
          <p class="warning-text">هذا الإجراء لا يمكن التراجع عنه!</p>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn--secondary" (click)="closeDeleteModal()">
            إلغاء
          </button>
          <button type="button" class="btn btn--danger" (click)="deleteUsers()" [disabled]="isDeleting">
            <span *ngIf="!isDeleting">نعم، احذف</span>
            <span *ngIf="isDeleting">جاري الحذف...</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" [class.toast--show]="showToast" [class]="'toast--' + toastType">
    <svg *ngIf="toastType === 'success'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
      <polyline points="22 4 12 14.01 9 11.01"/>
    </svg>
    <svg *ngIf="toastType === 'error'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"/>
      <line x1="15" y1="9" x2="9" y2="15"/>
      <line x1="9" y1="9" x2="15" y2="15"/>
    </svg>
    <span>{{ toastMessage }}</span>
  </div>
</div>
