<!-- src/app/features/products/products.component.html -->
<div class="products-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-overlay">
    <div class="spinner"></div>
    <p>جاري تحميل المنتجات...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading">
    <!-- Header with Search and Sort -->
    <div class="products-header">
      <div class="header-top">
        <h1 class="products-title">
          <i class="bi bi-bag-check"></i>
          <span>منتجاتنا</span>
        </h1>
        <div class="header-badge">
          <i class="bi bi-box-seam"></i>
          <span>{{ products.length }} منتج</span>
        </div>
      </div>

      <div class="header-controls">
        <!-- Search Bar -->
        <div class="search-container">
          <i class="bi bi-search"></i>
          <input
            type="text"
            placeholder="ابحث عن منتج..."
            [(ngModel)]="searchQuery"
            (ngModelChange)="onSearchChange($event)"
            class="search-input"
          />
          <button
            *ngIf="searchQuery"
            class="clear-search"
            (click)="searchQuery = ''; onSearchChange('')"
          >
            <i class="bi bi-x-lg"></i>
          </button>
        </div>

        <!-- Sort Dropdown -->
        <div class="sort-container">
          <i class="bi bi-sort-down"></i>
          <select [(ngModel)]="selectedSort" (ngModelChange)="onSortChange()" class="sort-select">
            <option *ngFor="let option of sortOptions" [value]="option.value">
              {{ option.label }}
            </option>
          </select>
        </div>

        <!-- Mobile Filter Toggle -->
        <button class="mobile-filter-btn" (click)="toggleMobileFilters()">
          <i class="bi bi-funnel"></i>
          <span>تصفية</span>
          <span class="filter-count" *ngIf="getActiveFiltersCount() > 0">{{ getActiveFiltersCount() }}</span>
        </button>
      </div>
    </div>

    <div class="products-content">
      <!-- Sidebar Filters -->
      <aside class="filters-sidebar" [class.mobile-open]="mobileFiltersOpen">
        <div class="filters-header">
          <div class="filters-title-section">
            <i class="bi bi-funnel-fill"></i>
            <h3>تصفية المنتجات</h3>
          </div>
          <button class="reset-filters-btn" (click)="resetFilters()" *ngIf="getActiveFiltersCount() > 0">
            <i class="bi bi-arrow-counterclockwise"></i>
            إعادة تعيين
          </button>
        </div>

        <!-- Categories Filter -->
        <div class="filter-section">
          <h4 class="filter-title">
            <i class="bi bi-grid-3x3-gap"></i>
            التصنيفات
          </h4>
          <ul class="categories-list">
            <li *ngFor="let category of categories">
              <button
                class="category-btn"
                [class.active]="selectedCategory === category.id"
                (click)="selectCategory(category.id)"
              >
                <i [class]="'bi ' + category.icon"></i>
                <span class="category-name">{{ category.name }}</span>
                <i class="bi bi-check-lg category-check" *ngIf="selectedCategory === category.id"></i>
              </button>
            </li>
          </ul>
        </div>

        <!-- Price Range Filter -->
        <div class="filter-section">
          <h4 class="filter-title">
            <i class="bi bi-currency-dollar"></i>
            نطاق السعر
          </h4>
          <div class="price-range-container">
            <div class="price-inputs-row">
              <div class="price-input-group">
                <label>من</label>
                <div class="input-wrapper">
                  <input
                    type="number"
                    [(ngModel)]="minPrice"
                    (ngModelChange)="onPriceRangeChange()"
                    [min]="priceRange.min"
                    [max]="maxPrice"
                    class="price-input"
                  />
                  <span class="currency">ج.م</span>
                </div>
              </div>
              <div class="price-separator">
                <i class="bi bi-arrow-left-right"></i>
              </div>
              <div class="price-input-group">
                <label>إلى</label>
                <div class="input-wrapper">
                  <input
                    type="number"
                    [(ngModel)]="maxPrice"
                    (ngModelChange)="onPriceRangeChange()"
                    [min]="minPrice"
                    [max]="priceRange.max"
                    class="price-input"
                  />
                  <span class="currency">ج.م</span>
                </div>
              </div>
            </div>
            <div class="price-range-display">
              <span><i class="bi bi-dash-circle"></i> {{ minPrice | number: '1.0-0' }} ج.م</span>
              <span><i class="bi bi-plus-circle"></i> {{ maxPrice | number: '1.0-0' }} ج.م</span>
            </div>
          </div>
        </div>

        <!-- Stock Availability Filter -->
        <div class="filter-section">
          <h4 class="filter-title">
            <i class="bi bi-box-seam"></i>
            التوفر
          </h4>
          <label class="checkbox-container">
            <input
              type="checkbox"
              [(ngModel)]="showInStockOnly"
              (ngModelChange)="onStockFilterChange()"
            />
            <span class="checkmark"></span>
            <span class="checkbox-label">
              <i class="bi bi-check-circle"></i>
              المنتجات المتوفرة فقط
            </span>
          </label>
        </div>

        <!-- Active Filters Summary -->
        <div class="active-filters" *ngIf="getActiveFiltersCount() > 0">
          <h4 class="filter-title">
            <i class="bi bi-funnel"></i>
            الفلاتر النشطة ({{ getActiveFiltersCount() }})
          </h4>
          <div class="filter-tags">
            <span class="filter-tag" *ngIf="selectedCategory !== 'all'">
              <i [class]="'bi ' + getCategoryIcon(selectedCategory)"></i>
              {{ getCategoryName(selectedCategory) }}
              <button (click)="selectCategory('all')" class="tag-remove">
                <i class="bi bi-x-lg"></i>
              </button>
            </span>
            <span class="filter-tag" *ngIf="searchQuery">
              <i class="bi bi-search"></i>
              {{ searchQuery }}
              <button (click)="searchQuery = ''; onSearchChange('')" class="tag-remove">
                <i class="bi bi-x-lg"></i>
              </button>
            </span>
            <span class="filter-tag" *ngIf="showInStockOnly">
              <i class="bi bi-check-circle"></i>
              متوفر فقط
              <button (click)="showInStockOnly = false; onStockFilterChange()" class="tag-remove">
                <i class="bi bi-x-lg"></i>
              </button>
            </span>
            <span class="filter-tag" *ngIf="minPrice !== priceRange.min || maxPrice !== priceRange.max">
              <i class="bi bi-currency-dollar"></i>
              {{ minPrice | number: '1.0-0' }} - {{ maxPrice | number: '1.0-0' }} ج.م
              <button (click)="resetPriceRange()" class="tag-remove">
                <i class="bi bi-x-lg"></i>
              </button>
            </span>
          </div>
        </div>

        <!-- Mobile Close Button -->
        <button class="mobile-close-btn" (click)="toggleMobileFilters()">
          <i class="bi bi-x-circle"></i>
          إغلاق
        </button>
      </aside>

      <!-- Products Grid -->
      <div class="products-main">
        <!-- Results Count (Desktop Only) -->
        <div class="results-header desktop-only">
          <p class="results-count">
            <i class="bi bi-box-seam"></i>
            <span class="count-number">{{ products.length }}</span>
            <span class="count-text">منتج</span>
          </p>
        </div>

        <div class="products-grid">
          <!-- Product Card -->
          <div *ngFor="let product of products" class="product-card" (click)="viewProductDetails(product)">
            <!-- Image Container -->
            <div class="product-image-container">
              <img
                [src]="product.images[0]?.url"
                [alt]="product.images[0]?.alt"
                class="product-image"
                loading="lazy"
              />

              <div class="offer-badge" *ngIf="product.offer?.enabled">
                <i class="bi bi-tag-fill"></i>
                -{{ product.offer?.discountPercentage }}%
              </div>

              <div class="image-overlay">
                <button
                  class="action-btn add-to-cart-btn"
                  title="إضافة إلى السلة"
                  (click)="addToCart($event, product)"
                  [disabled]="!product.inStock || isAddingToCart(product.id)"
                >
                  <i class="bi bi-cart-plus" *ngIf="!isAddingToCart(product.id)"></i>
                  <i class="bi bi-hourglass-split" *ngIf="isAddingToCart(product.id)"></i>
                </button>

                <button
                  class="action-btn details-btn"
                  title="عرض التفاصيل"
                  (click)="$event.stopPropagation(); viewProductDetails(product)"
                >
                  <i class="bi bi-eye"></i>
                </button>
              </div>

              <!-- Image Counter -->
              <div class="image-counter" *ngIf="product.images.length > 1">
                <i class="bi bi-images"></i>
                <span>{{ product.images.length }}</span>
              </div>
            </div>

            <!-- Product Info -->
            <div class="product-info">
              <span class="product-category">
                <i class="bi bi-bookmark"></i>
                {{ product.category }}
              </span>
              <h3 class="product-name">{{ product.name }}</h3>
              <p class="product-description">{{ product.description }}</p>

              <div class="product-footer">
                <div class="price-container">
                  <span class="product-price" *ngIf="!product.offer?.enabled">
                    {{ product.price | number: '1.0-0' }} ج.م
                  </span>
                  <div class="price-with-offer" *ngIf="product.offer?.enabled">
                    <span class="original-price">{{ product.price | number: '1.0-0' }} ج.م</span>
                    <span class="final-price">{{ product.finalPrice | number: '1.0-0' }} ج.م</span>
                  </div>
                </div>
                <span class="stock-badge" [class.in-stock]="product.inStock">
                  <i [class]="product.inStock ? 'bi bi-check-circle-fill' : 'bi bi-x-circle-fill'"></i>
                  {{ product.inStock ? 'متوفر' : 'غير متوفر' }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- No Products Message -->
        <div *ngIf="products.length === 0" class="no-products">
          <i class="bi bi-inbox"></i>
          <h3>لا توجد منتجات</h3>
          <p>لم نتمكن من العثور على منتجات تطابق معايير البحث</p>
          <button class="reset-btn" (click)="resetFilters()">
            <i class="bi bi-arrow-counterclockwise"></i>
            إعادة تعيين الفلاتر
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
